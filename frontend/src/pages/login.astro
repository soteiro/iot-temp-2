---
import Layout from '@/layouts/Layout.astro';


---
<Layout title="Login">
<main class="flex gap-4 flex-col items-center justify-center min-h-screen p-4">
    <h1 class="text-4xl font-bold">Inicia sesión</h1>
    <section class="flex flex-col gap-4 items-center justify-center border p-4 rounded-lg shadow-lg"> 
      <form id="loginForm" class="flex flex-col gap-1 items-left justify-center p-6">
        <label class="label" for="email">Email</label>
        <input class="input" type="text" id="email" name="email" required autofocus />
        <br />
        <label class="label" for="password">Contraseña</label>
        <input class="input" type="password" id="password" name="password" required />
        <br />
        <button class="btn btn-primary" type="submit">Login</button>
      </form>
      <div class="block">
    <span id="loadingSpinner" 
    class="loading loading-ring loading-2xl text-primary hidden">
  </span>
    </div>
    </section>
    <h2>Usuarios de prueba</h2>
    <section class="flex flex-col gap-4 items-center justify-center p-4 shadow-lg mb-2">
        <button onclick="setUser1()" class="btn btn-accent">Usuario de Prueba 1</button>               
        <button onclick="setUser2()" class="btn btn-accent">Usuario de Prueba 2</button>
    </section>
</main>
</Layout>

<script>
  
  const loginForm = document.getElementById('loginForm');
  const loadingSpinner = document.getElementById('loadingSpinner');
  if (loginForm && loadingSpinner) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email') as HTMLInputElement;
      const passwordInput = document.getElementById('password') as HTMLInputElement;
      loadingSpinner.classList.remove('hidden');
      if (!emailInput.value || !passwordInput.value) {
        alert('Por favor ingresa email y contraseña');
        return;
      }
      
      try {
        const response = await fetch('api/auth/login', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: emailInput.value, password: passwordInput.value }),
          credentials: 'include' 
        });
        
        if (response.ok) {
          window.location.href = '/dashboard';

        } else {
          loadingSpinner.classList.add('hidden');
          const errorData = await response.json();
          alert(`Error: ${errorData.message || 'Error en el login'}`);
        }
      } catch(error) {
        console.error(error);
      }
    });
  }

  function setUser1() {
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    emailInput.value = 'debug@mail.com';
    passwordInput.value = '97158700';
  }

  function setUser2(){
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    emailInput.value = 'test1@mail.com';
    passwordInput.value = '97158700';
  }

  // Hacer las funciones accesibles globalmente para los `onclick`
  (window as any).setUser1 = setUser1;
  (window as any).setUser2 = setUser2;
</script>