---
import Layout from '@/layouts/Layout.astro';

---
<Layout title="Login - IoT Monitor">
<main class="min-h-screen bg-base-200 flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Card principal -->
    <div class="card bg-base-100 shadow-2xl">
      <div class="card-body">
        <!-- Header del card -->
        <div class="text-center mb-6">
          <div class="inline-block p-3 bg-primary/10 rounded-full mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <h1 class="text-3xl font-bold">Iniciar Sesión</h1>
          <p class="text-base-content/70 mt-2">Accede a tu panel de control IoT</p>
        </div>

        <!-- Formulario -->
        <form id="loginForm" class="space-y-4">
          <div class="form-control">
            <label class="label" for="email">
              <span class="label-text font-medium">Email</span>
            </label>
            <input 
              class="input input-bordered w-full focus:input-primary" 
              type="email" 
              id="email" 
              name="email" 
              placeholder="tu@email.com"
              required 
              autofocus 
            />
          </div>

          <div class="form-control">
            <label class="label" for="password">
              <span class="label-text font-medium">Contraseña</span>
            </label>
            <input 
              class="input input-bordered w-full focus:input-primary" 
              type="password" 
              id="password" 
              name="password" 
              placeholder="••••••••"
              required 
            />
          </div>

          <button class="btn btn-primary w-full gap-2" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
            </svg>
            Iniciar Sesión
          </button>
        </form>

        <!-- Loading Spinner -->
        <div class="flex justify-center mt-4">
          <span id="loadingSpinner" class="loading loading-ring loading-lg text-primary hidden"></span>
        </div>

        <!-- Divider -->
        <div class="divider text-base-content/50">O prueba con</div>

        <!-- Usuarios de prueba -->
        <div class="space-y-2">
          <button onclick="setUser1()" class="btn btn-outline btn-accent w-full gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Usuario Demo 1
          </button>
          
          <button onclick="setUser2()" class="btn btn-outline btn-accent w-full gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Usuario Demo 2
          </button>
        </div>

        <!-- Link a registro -->
        <div class="text-center mt-6 pt-4 border-t border-base-300">
          <p class="text-base-content/70">
            ¿No tienes cuenta? 
            <a href="/register" class="link link-primary font-semibold">Crear cuenta</a>
          </p>
        </div>
      </div>
    </div>

    <!-- Info adicional -->
    <div class="text-center mt-6">
      <p class="text-base-content/60 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Conexión segura con autenticación JWT
      </p>
    </div>
  </div>
</main>
</Layout>

<script>
  
  const loginForm = document.getElementById('loginForm');
  const loadingSpinner = document.getElementById('loadingSpinner');
  if (loginForm && loadingSpinner) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email') as HTMLInputElement;
      const passwordInput = document.getElementById('password') as HTMLInputElement;
      loadingSpinner.classList.remove('hidden');
      if (!emailInput.value || !passwordInput.value) {
        alert('Por favor ingresa email y contraseña');
        return;
      }
      
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: emailInput.value, password: passwordInput.value }),
          credentials: 'include' 
        });
        
        if (response.ok) {
          window.location.href = '/dashboard';

        } else {
          loadingSpinner.classList.add('hidden');
          const errorData = await response.json();
          alert(`Error: ${errorData.message || 'Error en el login'}`);
        }
      } catch(error) {
        console.error(error);
      }
    });
  }

  function setUser1() {
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    emailInput.value = 'debug@mail.com';
    passwordInput.value = '97158700';
  }

  function setUser2(){
    const emailInput = document.getElementById('email') as HTMLInputElement;
    const passwordInput = document.getElementById('password') as HTMLInputElement;
    emailInput.value = 'test1@mail.com';
    passwordInput.value = '97158700';
  }

  (window as any).setUser1 = setUser1;
  (window as any).setUser2 = setUser2;
</script>