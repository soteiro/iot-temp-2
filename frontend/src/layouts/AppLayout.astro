---
import '@styles/global.css';
import Aside from '@/components/Aside.astro';

interface Props {
    title: string;
    userName?: string;
    userEmail?: string;
}

const { title } = Astro.props;

// Intenta obtener de cookies
let userName = Astro.cookies.get('userName')?.value;
let userEmail = Astro.cookies.get('userEmail')?.value;

// Si faltan datos, hace fetch y guarda en cookies
if (!userName || !userEmail) {
    const response = await fetch(
        `${import.meta.env.PUBLIC_API_URL || 'http://localhost:8787'}/users/profile`,
        {
            headers: {
                'Authorization': `Bearer ${Astro.cookies.get('sb-access-token')?.value || ''}`,
            },
        }
    );
    if (response.ok) {
        const data = await response.json();
        userName = data.name || "Usuario";
         userEmail = data.email || "<Email>";

        // Guardar en cookies para futuros SSR (solo si tienes acceso a Astro.cookies.set)
        if (Astro.cookies.set) {
            Astro.cookies.set('userName', userName ?? '', { path: '/', httpOnly: false });
            Astro.cookies.set('userEmail', userEmail ?? '', { path: '/', httpOnly: false });
        }
    } else {
        userName = "Usuario";
        userEmail = "<Email>";
    }
}
---
<!DOCTYPE html>
<html lang="es" transition:name="fade" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <script is:inline>
        const html = document.documentElement
        const theme = html.getAttribute('data-theme')
        const themeKey = 'theme-preference'
        const toggleTheme = ()=>{
            const currentTheme = html.getAttribute('data-theme')
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
            html.setAttribute('data-theme', newTheme)
            localStorage.setItem(themeKey, newTheme)
        }	
        
        try{
            const storedTheme = localStorage.getItem(themeKey)
            if(storedTheme && (storedTheme === 'dark' || storedTheme === 'light')){
                if(storedTheme !== theme) html.setAttribute('data-theme', storedTheme)
            }
        } catch{
            console.warn('No se pudo acceder a localStorage')
        }
        window.toggleTheme = toggleTheme;

    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
</head>
<body class="h-screen overflow-hidden">
    <div class="flex h-full">
        <Aside userEmail={userEmail} userName={userName} />
        
        <!-- Contenido principal -->
        <main class="flex-1 overflow-y-auto bg-base-200">
            <div class="p-4 md:p-6 lg:p-8 max-w-none">
                <slot />
            </div>
        </main>
    </div>
</body>
</html>