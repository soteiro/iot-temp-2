---
import { StatCard } from "@/components/dashboard/StatCard";


interface Props {
  tempData: { temperature: number; humidity: number; timestamp: string }[];
}
const { tempData } = Astro.props;

let temperatures = [];
let avgTemp = 0;
let maxTemp = '0.00';
let minTemp = '0.00';
let currentTemp = '0.00';
let humidity = [];
let avgHum = 0;
let maxHum = '0.00';
let minHum = '0.00';
let currentHum = '0.00';

try {
  if (tempData && Array.isArray(tempData) && tempData.length > 0) {
    temperatures = tempData.map(
      (d: { temperature: number }) => d.temperature
    ).filter((t) => t != null && !isNaN(t));
    
    if (temperatures.length > 0) {
      avgTemp = Math.round(
        temperatures.reduce((a: number, b: number) => a + b, 0) / temperatures.length
      );
      maxTemp = Math.max(...temperatures).toFixed(2);
      minTemp = Math.min(...temperatures).toFixed(2);
      const lastTemp = temperatures[temperatures.length - 1];
      currentTemp = lastTemp != null ? lastTemp.toFixed(2) : '0.00';
    }

    humidity = tempData.map((d: { humidity: number }) => d.humidity).filter((h) => h != null && !isNaN(h));
    
    if (humidity.length > 0) {
      avgHum = Math.round(
        humidity.reduce((a: number, b: number) => a + b, 0) / humidity.length
      );
      maxHum = Math.max(...humidity).toFixed(2);
      minHum = Math.min(...humidity).toFixed(2);
      const lastHum = humidity[humidity.length - 1];
      currentHum = lastHum != null ? lastHum.toFixed(2) : '0.00';
    }
  }
} catch (error) {
  console.error('Error calculando métricas en StatsBox:', error);
}
---

<!-- TODO: mejorar los iconos, poner algunos mas bonitos -->
<section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">

  <StatCard
    title="Temperatura Promedio"
    value={`${avgTemp}°C`}
    icon="/statsIcons/thermometer.svg"
  color="primary"
  />
  <StatCard
    title="Temperatura Máxima"
    value={`${maxTemp}°C`}
    icon="/statsIcons/arrow-up.svg"
  color="primary"
  />
  <StatCard
    title="Temperatura Mínima"
    value={`${minTemp}°C`}
    icon="/statsIcons/arrow-down.svg"
  color="primary"
  />
  <StatCard
    title="Temperatura Actual"
    value={`${currentTemp}°C`}
    icon="/statsIcons/thermometer.svg"
  color="primary"
  />
</section>
<div class="divider my-0"></div>


<section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 mt-4">
  <StatCard
    title="Humedad Promedio"
    value={`${avgHum}%`}
    icon="/statsIcons/humidity.svg"
  color="info"
  />
  <StatCard
    title="Humedad Máxima"
    value={`${maxHum}%`}
    icon="/statsIcons/arrow-up.svg"
  color="info"
  />
  <StatCard
    title="Humedad Mínima"
    value={`${minHum}%`}
    icon="/statsIcons/arrow-down.svg"
  color="info"
  />
  <StatCard
    title="Humedad Actual"
    value={`${currentHum}%`}
    icon="/statsIcons/humidity.svg"
  color="info"
  />
</section>
